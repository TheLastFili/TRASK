<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel Crisis Protocol Tournament Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .tab-container {
            display: flex;
            margin-bottom: 16px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 16px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: none;
            outline: none;
            transition: 0.3s;
            font-weight: bold;
        }
        .tab.active {
            background-color: #2c3e50;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 16px 0;
        }
        .active-content {
            display: block;
        }
        .player-container {
            margin-bottom: 16px;
            border: 1px solid #ddd;
            padding: 16px;
            border-radius: 8px;
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .player-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .stat-item {
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
            min-width: 150px;
        }
        .objective-item {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #2980b9;
        }
        .add-player-container {
            margin-top: 24px;
        }
        input, select {
            padding: 8px;
            margin-right: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .running-total {
            font-weight: bold;
            color: #e74c3c;
        }
        .edit-btn {
            background-color: #f39c12;
            margin-right: 8px;
            font-size: 12px;
            padding: 4px 8px;
        }
        .delete-btn {
            background-color: #e74c3c;
            font-size: 12px;
            padding: 4px 8px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .adjust-container {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .adjust-container button {
            margin: 0 8px;
        }
        .adjust-value {
            width: 40px;
            text-align: center;
        }
        .info-box {
            background-color: #d5f5e3;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .objectives-box {
            background-color: #ebf5fb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .hidden {
            display: none;
        }
        .toggle-details {
            background-color: #34495e;
            font-size: 12px;
        }
        .objective-details {
            display: none;
            padding: 10px;
            margin-top: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .task-completed {
            background-color: #d4edda;
        }
        .number-input {
            width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Marvel Crisis Protocol Tournament Tracker</h1>
    
    <div class="info-box">
        <p>Track player performances across 7 games with this tracker. Stats are saved locally on your device.</p>
        <p>Share this page URL with other participants to access the same tracker.</p>
    </div>

    <div class="objectives-box">
        <h3>Tournament Objectives</h3>
        <button class="toggle-details" id="toggle-objective-btn">Show/Hide Details</button>
        <div id="objective-details" class="objective-details">
            <p><strong>Mutant Detected:</strong> KO an enemy Mutant - points equal to the enemy Mutant's Threat</p>
            <p><strong>Take Them Out:</strong> KO ANY enemy leader - points equal to the enemy leader's Threat</p>
            <p><strong>Bounty Hunter:</strong> Claim a bounty (secret until achieved) - 5 points</p>
            <p><strong>Total Aggression:</strong> Win a game by tabling your opponent - 10 points</p>
            <p><strong>Extinction Agenda:</strong> KO an Extinction Agenda target - points equal to the target's Threat</p>
            <p><strong>Charles Was Right:</strong> End the game with an allied character still holding the enemy Extinction Agenda token - 3 points</p>
            <p><strong>No More Mutants:</strong> KO 5 characters (count carries over across all games) - 5 points per 5 KOs</p>
        </div>
    </div>
    
    <div class="tab-container" id="tab-container">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="game1">Game 1</button>
        <button class="tab" data-tab="game2">Game 2</button>
        <button class="tab" data-tab="game3">Game 3</button>
        <button class="tab" data-tab="game4">Game 4</button>
        <button class="tab" data-tab="game5">Game 5</button>
        <button class="tab" data-tab="game6">Game 6</button>
        <button class="tab" data-tab="game7">Game 7</button>
    </div>
    
    <div id="overview" class="tab-content active-content">
        <h2>Tournament Overview</h2>
        <div id="overview-players"></div>
        
        <div class="add-player-container">
            <h3>Add New Player</h3>
            <input type="text" id="new-player-name" placeholder="Player Name">
            <button id="add-player-btn">Add Player</button>
        </div>
    </div>
    
    <div id="game1" class="tab-content">
        <h2>Game 1</h2>
        <div id="game1-players"></div>
    </div>
    
    <div id="game2" class="tab-content">
        <h2>Game 2</h2>
        <div id="game2-players"></div>
    </div>
    
    <div id="game3" class="tab-content">
        <h2>Game 3</h2>
        <div id="game3-players"></div>
    </div>
    
    <div id="game4" class="tab-content">
        <h2>Game 4</h2>
        <div id="game4-players"></div>
    </div>
    
    <div id="game5" class="tab-content">
        <h2>Game 5</h2>
        <div id="game5-players"></div>
    </div>
    
    <div id="game6" class="tab-content">
        <h2>Game 6</h2>
        <div id="game6-players"></div>
    </div>
    
    <div id="game7" class="tab-content">
        <h2>Game 7</h2>
        <div id="game7-players"></div>
    </div>
    
    <!-- Edit modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-modal">&times;</span>
            <h2>Adjust Stats</h2>
            <div id="editModalContent"></div>
            <button id="save-changes-btn">Save Changes</button>
        </div>
    </div>

    <script>
        // Global variables
        let players = [];
        const GAMES = 7;
        const STORAGE_KEY = 'marvelCrisisProtocolData';
        let editingPlayer = null;
        let editingGame = null;
        let tempStats = {};
        
        // Define objectives
        const objectives = {
            mutantDetected: { 
                name: "Mutant Detected", 
                description: "KO an enemy Mutant", 
                pointsDescription: "Enemy Mutant's Threat",
                variablePoints: true 
            },
            takeThemOut: { 
                name: "Take Them Out", 
                description: "KO ANY enemy leader", 
                pointsDescription: "Enemy leader's Threat",
                variablePoints: true 
            },
            bountyHunter: { 
                name: "Bounty Hunter", 
                description: "Claim a bounty (secret until achieved)", 
                pointsDescription: "5 points",
                points: 5 
            },
            totalAggression: { 
                name: "Total Aggression", 
                description: "Win a game by tabling your opponent", 
                pointsDescription: "10 points",
                points: 10 
            },
            extinctionAgenda: { 
                name: "Extinction Agenda", 
                description: "KO an Extinction Agenda target", 
                pointsDescription: "Target's Threat",
                variablePoints: true 
            },
            charlesWasRight: { 
                name: "Charles Was Right", 
                description: "End the game with an allied character still holding the enemy Extinction Agenda token", 
                pointsDescription: "3 points",
                points: 3 
            },
            noMoreMutants: { 
                name: "No More Mutants", 
                description: "KO 5 characters (carries over across all games)", 
                pointsDescription: "5 points per 5 KOs",
                points: 5,
                cumulative: true 
            }
        };
        
        // Function to toggle objective details
        function toggleObjectiveDetails() {
            const details = document.getElementById('objective-details');
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }
        
        // Function to handle tab switching
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active-content");
            }
            
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active-content");
            evt.currentTarget.classList.add("active");
        }
        
        // Function to add a new player
        function addPlayer() {
            const nameInput = document.getElementById('new-player-name');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a player name');
                return;
            }
            
            if (players.some(p => p.name === name)) {
                alert('A player with this name already exists');
                return;
            }
            
            const player = {
                name: name,
                games: Array(GAMES).fill().map(() => ({
                    charactersKilled: 0,
                    objectives: {
                        mutantDetected: { completed: false, points: 0, threatValue: 0 },
                        takeThemOut: { completed: false, points: 0, threatValue: 0 },
                        bountyHunter: { completed: false, points: 0 },
                        totalAggression: { completed: false, points: 0 },
                        extinctionAgenda: { completed: false, points: 0, threatValue: 0 },
                        charlesWasRight: { completed: false, points: 0 }
                    }
                })),
                noMoreMutants: { count: 0, achievedCount: 0 } // Track the cumulative objective separately
            };
            
            players.push(player);
            saveData();
            renderAllPlayers();
            nameInput.value = '';
        }
        
        // Function to delete a player
        function deletePlayer(playerIndex) {
            if (confirm('Are you sure you want to delete this player?')) {
                players.splice(playerIndex, 1);
                saveData();
                renderAllPlayers();
            }
        }
        
        // Calculate total points including all objectives
        function calculateTotalPoints(player) {
            let totalPoints = 0;
            
            // Add up points from each game
            for (let i = 0; i < GAMES; i++) {
                // Add objective points from this game
                Object.values(player.games[i].objectives).forEach(objective => {
                    if (objective.completed) {
                        totalPoints += objective.points;
                    }
                });
            }
            
            // Add cumulative No More Mutants objective points
            totalPoints += player.noMoreMutants.achievedCount * objectives.noMoreMutants.points;
            
            return totalPoints;
        }
        
        // Calculate total characters killed
        function calculateTotalKills(player) {
            return player.games.reduce((sum, game) => sum + game.charactersKilled, 0);
        }
        
        // Toggle objective completion
        function toggleObjective(playerIndex, gameIndex, objectiveName) {
            const player = players[playerIndex];
            const objective = player.games[gameIndex].objectives[objectiveName];
            
            objective.completed = !objective.completed;
            
            // If objective is now completed and has fixed points, set them
            if (objective.completed && objectives[objectiveName].points) {
                objective.points = objectives[objectiveName].points;
            } else if (!objective.completed) {
                objective.points = 0;
            }
            
            saveData();
            renderAllPlayers();
        }
        
        // Update objective threat value and points
        function updateObjectiveThreat(playerIndex, gameIndex, objectiveName, threatValue) {
            const player = players[playerIndex];
            const objective = player.games[gameIndex].objectives[objectiveName];
            
            objective.threatValue = parseInt(threatValue) || 0;
            if (objective.completed) {
                objective.points = objective.threatValue;
            }
            
            saveData();
            renderAllPlayers();
        }
        
        // Update characters killed and check for No More Mutants achievement
        function updateCharactersKilled(playerIndex, gameIndex, value) {
            const player = players[playerIndex];
            const game = player.games[gameIndex];
            
            game.charactersKilled += value;
            if (game.charactersKilled < 0) {
                game.charactersKilled = 0;
            }
            
            // Update the cumulative count for No More Mutants
            player.noMoreMutants.count = calculateTotalKills(player);
            
            // Check if they've achieved new sets of 5 kills
            const achievedSets = Math.floor(player.noMoreMutants.count / 5);
            if (achievedSets > player.noMoreMutants.achievedCount) {
                player.noMoreMutants.achievedCount = achievedSets;
            }
            
            saveData();
            renderAllPlayers();
        }
        
        function openEditModal(playerIndex, gameIndex) {
            editingPlayer = playerIndex;
            editingGame = gameIndex;
            
            const playerData = players[playerIndex];
            const modalContent = document.getElementById('editModalContent');
            
            let html = `<h3>${playerData.name} - ${gameIndex === -1 ? 'All Games' : 'Game ' + (gameIndex + 1)}</h3>`;
            
            if (gameIndex === -1) {
                // Edit all games
                for (let i = 0; i < GAMES; i++) {
                    const game = playerData.games[i];
                    html += `<h4>Game ${i + 1}</h4>`;
                    
                    html += `<div class="adjust-container">
                        <label>Characters Killed:</label>
                        <button class="adjust-temp-stat" data-game="${i}" data-stat="charactersKilled" data-value="-1">-</button>
                        <input type="number" class="adjust-value" id="temp-game${i}-charactersKilled" value="${game.charactersKilled}" min="0">
                        <button class="adjust-temp-stat" data-game="${i}" data-stat="charactersKilled" data-value="1">+</button>
                    </div>`;
                    
                    // Add objective editing
                    for (const [key, obj] of Object.entries(objectives)) {
                        if (key === 'noMoreMutants') continue; // Skip the cumulative objective
                        
                        const objectiveStatus = game.objectives[key];
                        html += `<div class="adjust-container">
                            <label>${obj.name}:</label>
                            <input type="checkbox" id="temp-game${i}-${key}-completed" ${objectiveStatus.completed ? 'checked' : ''}>
                        </div>`;
                        
                        if (obj.variablePoints) {
                            html += `<div class="adjust-container">
                                <label>Threat Value:</label>
                                <input type="number" class="adjust-value" id="temp-game${i}-${key}-threat" value="${objectiveStatus.threatValue}" min="0">
                            </div>`;
                        }
                    }
                }
            } else {
                // Edit specific game
                const game = playerData.games[gameIndex];
                
                html += `<div class="adjust-container">
                    <label>Characters Killed:</label>
                    <button class="adjust-temp-stat" data-game="${gameIndex}" data-stat="charactersKilled" data-value="-1">-</button>
                    <input type="number" class="adjust-value" id="temp-game${gameIndex}-charactersKilled" value="${game.charactersKilled}" min="0">
                    <button class="adjust-temp-stat" data-game="${gameIndex}" data-stat="charactersKilled" data-value="1">+</button>
                </div>`;
                
                // Add objective editing
                for (const [key, obj] of Object.entries(objectives)) {
                    if (key === 'noMoreMutants') continue; // Skip the cumulative objective
                    
                    const objectiveStatus = game.objectives[key];
                    html += `<div class="adjust-container">
                        <label>${obj.name}:</label>
                        <input type="checkbox" id="temp-game${gameIndex}-${key}-completed" ${objectiveStatus.completed ? 'checked' : ''}>
                    </div>`;
                    
                    if (obj.variablePoints) {
                        html += `<div class="adjust-container">
                            <label>Threat Value:</label>
                            <input type="number" class="adjust-value" id="temp-game${gameIndex}-${key}-threat" value="${objectiveStatus.threatValue}" min="0">
                        </div>`;
                    }
                }
            }
            
            modalContent.innerHTML = html;
            document.getElementById('editModal').style.display = 'block';
            
            // Initialize temp stats
            tempStats = {};
            if (gameIndex === -1) {
                for (let i = 0; i < GAMES; i++) {
                    initializeTempGameStats(playerData, i);
                }
            } else {
                initializeTempGameStats(playerData, gameIndex);
            }

            // Add event listeners to buttons inside the modal
            document.querySelectorAll('.adjust-temp-stat').forEach(button => {
                button.addEventListener('click', function() {
                    const gameIndex = parseInt(this.getAttribute('data-game'));
                    const stat = this.getAttribute('data-stat');
                    const value = parseInt(this.getAttribute('data-value'));
                    adjustTempStat(gameIndex, stat, value);
                });
            });
        }
        
        function initializeTempGameStats(playerData, gameIndex) {
            const game = playerData.games[gameIndex];
            tempStats[`game${gameIndex}-charactersKilled`] = game.charactersKilled;
            
            for (const [key, obj] of Object.entries(objectives)) {
                if (key === 'noMoreMutants') continue; // Skip the cumulative objective
                
                tempStats[`game${gameIndex}-${key}-completed`] = game.objectives[key].completed;
                if (obj.variablePoints) {
                    tempStats[`game${gameIndex}-${key}-threat`] = game.objectives[key].threatValue;
                }
            }
        }
        
        function adjustTempStat(gameIndex, stat, value) {
            const inputId = `temp-game${gameIndex}-${stat}`;
            const input = document.getElementById(inputId);
            let currentValue = parseInt(input.value) || 0;
            currentValue += value;
            if (currentValue < 0) currentValue = 0;
            input.value = currentValue;
            tempStats[`game${gameIndex}-${stat}`] = currentValue;
        }
        
        function saveChanges() {
            if (editingPlayer === null || editingGame === null) return;
            
            const playerData = players[editingPlayer];
            
            if (editingGame === -1) {
                // Save all games
                for (let i = 0; i < GAMES; i++) {
                    saveGameChanges(playerData, i);
                }
            } else {
                // Save specific game
                saveGameChanges(playerData, editingGame);
            }
            
            // Recalculate No More Mutants achievement
            updateNoMoreMutantsProgress(playerData);
            
            saveData();
            renderAllPlayers();
            closeModal();
        }
        
        function saveGameChanges(playerData, gameIndex) {
            const game = playerData.games[gameIndex];
            
            // Save characters killed
            game.charactersKilled = parseInt(document.getElementById(`temp-game${gameIndex}-charactersKilled`).value) || 0;
            
            // Save objectives
            for (const [key, obj] of Object.entries(objectives)) {
                if (key === 'noMoreMutants') continue; // Skip the cumulative objective
                
                const objectiveElement = document.getElementById(`temp-game${gameIndex}-${key}-completed`);
                if (objectiveElement) {
                    game.objectives[key].completed = objectiveElement.checked;
                    
                    // Handle variable points
                    if (obj.variablePoints) {
                        const threatElement = document.getElementById(`temp-game${gameIndex}-${key}-threat`);
                        if (threatElement) {
                            game.objectives[key].threatValue = parseInt(threatElement.value) || 0;
                            if (game.objectives[key].completed) {
                                game.objectives[key].points = game.objectives[key].threatValue;
                            } else {
                                game.objectives[key].points = 0;
                            }
                        }
                    } else {
                        // Fixed points
                        game.objectives[key].points = game.objectives[key].completed ? obj.points : 0;
                    }
                }
            }
        }
        
        function updateNoMoreMutantsProgress(playerData) {
            playerData.noMoreMutants.count = calculateTotalKills(playerData);
            playerData.noMoreMutants.achievedCount = Math.floor(playerData.noMoreMutants.count / 5);
        }
        
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            editingPlayer = null;
            editingGame = null;
            tempStats = {};
        }
        
        // Storage functions
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(players));
            } catch (e) {
                console.error("Failed to save data to localStorage:", e);
                alert("Failed to save data. Storage might be full or disabled.");
            }
        }
        
        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    players = JSON.parse(data);
                    
                    // Compatibility check for older data format
                    players.forEach(player => {
                        // Add noMoreMutants tracking if it doesn't exist
                        if (!player.noMoreMutants) {
                            player.noMoreMutants = { count: 0, achievedCount: 0 };
                            updateNoMoreMutantsProgress(player);
                        }
                        
                        // Ensure all objectives exist in each game
                        player.games.forEach(game => {
                            if (!game.objectives) {
                                game.objectives = {};
                            }
                            
                            // Ensure all objective types exist
                            for (const [key, obj] of Object.entries(objectives)) {
                                if (key === 'noMoreMutants') continue; // Skip the cumulative objective
                                
                                if (!game.objectives[key]) {
                                    if (obj.variablePoints) {
                                        game.objectives[key] = { completed: false, points: 0, threatValue: 0 };
                                    } else {
                                        game.objectives[key] = { completed: false, points: 0 };
                                    }
                                }
                            }
                        });
                    });
                }
            } catch (e) {
                console.error("Failed to load data from localStorage:", e);
                alert("Failed to load saved data. Using default values.");
                players = [];
            }
        }
        
        // Rendering functions
        function renderAllPlayers() {
            renderOverview();
            for (let i = 0; i < GAMES; i++) {
                renderGamePlayers(i);
            }
        }
        
        function renderOverview() {
            const container = document.getElementById('overview-players');
            let html = '';
            
            players.forEach((player, playerIndex) => {
                const totalKills = calculateTotalKills(player);
                const totalPoints = calculateTotalPoints(player);
                
                html += `<div class="player-container">
                    <div class="player-header">
                        <h3>${player.name}</h3>
                        <div>
                            <button class="edit-btn" data-player="${playerIndex}" data-game="-1">Edit All Games</button>
                            <button class="delete-btn" data-player="${playerIndex}">Delete</button>
                        </div>
                    </div>
                    <div class="player-stats">
                        <div class="stat-item">
                            <div>Characters Killed: <span class="running-total">${totalKills}</span></div>
                            <div>No More Mutants: ${player.noMoreMutants.achievedCount * objectives.noMoreMutants.points} pts (${player.noMoreMutants.count}/5 kills)</div>
                        </div>
                        <div class="stat-item">
                            <div>Total Points: <span class="running-total">${totalPoints}</span></div>
                        </div>
                    </div>
                </div>`;
            });
            
            if (players.length === 0) {
                html = '<p>No players added yet. Add players using the form below.</p>';
            }
            
            container.innerHTML = html;
            
            // Add event listeners to the edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const playerIndex = parseInt(this.getAttribute('data-player'));
                    const gameIndex = parseInt(this.getAttribute('data-game'));
                    openEditModal(playerIndex, gameIndex);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const playerIndex = parseInt(this.getAttribute('data-player'));
                    deletePlayer(playerIndex);
                });
            });
        }
        
        function renderGamePlayers(gameIndex) {
            const container = document.getElementById(`game${gameIndex+1}-players`);
            let html = '';
            
            players.forEach((player, playerIndex) => {
                const game = player.games[gameIndex];
                
                // Calculate game points
                let gamePoints = 0;
                Object.values(game.objectives).forEach(objective => {
                    if (objective.completed) {
                        gamePoints += objective.points;
                    }
                });
                
                html += `<div class="player-container">
                    <div class="player-header">
                        <h3>${player.name}</h3>
                        <button class="edit-btn" data-player="${playerIndex}" data-game="${gameIndex}">Edit</button>
                    </div>
                    <div class="player-stats">
                        <div class="stat-item">
                            <div>Characters Killed: ${game.charactersKilled}</div>
                        </div>
                        <div class="stat-item">
                            <div>Game Points: ${gamePoints}</div>
                        </div>
